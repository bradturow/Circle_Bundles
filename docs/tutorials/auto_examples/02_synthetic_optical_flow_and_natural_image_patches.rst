
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "tutorials/auto_examples/02_synthetic_optical_flow_and_natural_image_patches.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_tutorials_auto_examples_02_synthetic_optical_flow_and_natural_image_patches.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_tutorials_auto_examples_02_synthetic_optical_flow_and_natural_image_patches.py:


Application demo: optical flow and natural image patches
========================================================

This tutorial demonstrates applications of ``circle_bundles`` to synthetic optical flow data
and synthetic natural image patches.

We consider two synthetic datasets sampled from known models for spaces of high-contrast
:math:`n\times n` patches:

- Optical flow patch model: a torus embedded in :math:`\mathbb{R}^{2n^2}`.
- Natural image patch model: a Klein bottle embedded in :math:`\mathbb{R}^{n^2}`.

For each dataset, we compute a feature map
:math:`\pi(x) \in \mathbb{RP}^1 \cong \mathbb{S}^1` (predominant direction),
build a metric-ball cover of the base, and run the local-to-global bundle pipeline.

Notes
-----
- This is an application-oriented demo. For a minimal tutorial of the core pipeline,
  see the "Hopf and SO(3)" tutorial.
- Some steps (Ripser) can be expensive; set ``RUN_HEAVY = True`` if you want full runs.

.. GENERATED FROM PYTHON SOURCE LINES 26-28

Imports
-------

.. GENERATED FROM PYTHON SOURCE LINES 28-46

.. code-block:: Python

    import numpy as np
    import matplotlib.pyplot as plt

    import circle_bundles as cb
    from circle_bundles import RP1AngleMetric as rp1_metric
    import circle_bundles.synthetic as sy
    import circle_bundles.viz as vz
    import circle_bundles.optical_flow as of

    # Persistent homology (optional / potentially heavy)
    from ripser import ripser
    from persim import plot_diagrams

    # Optional: local circular coordinates via Dreimac
    from dreimac import CircularCoords

    RUN_HEAVY = False  # set True to run Ripser with larger n_perm, etc.








.. GENERATED FROM PYTHON SOURCE LINES 47-49

Torus model: high-contrast optical flow patches
-----------------------------------------------

.. GENERATED FROM PYTHON SOURCE LINES 49-58

.. code-block:: Python

    n_flow_patches = 5000
    n_flow = 3  # patch size

    rng = np.random.default_rng(0)
    flow_data = sy.sample_opt_flow_torus(n_flow_patches, dim=n_flow, rng=rng)[0]
    print(f"{n_flow_patches} {n_flow}-by-{n_flow} optical flow patches generated.")

    patch_vis = of.make_patch_visualizer()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    5000 3-by-3 optical flow patches generated.




.. GENERATED FROM PYTHON SOURCE LINES 59-60

Predominant flow direction :math:`\\pi(x) \\in \\mathbb{RP}^1`

.. GENERATED FROM PYTHON SOURCE LINES 60-63

.. code-block:: Python

    predom_dirs = of.get_predominant_dirs(flow_data)[0]
    print("Predominant directions computed.")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Predominant directions computed.




.. GENERATED FROM PYTHON SOURCE LINES 64-65

Visualize a random sample, arranged by direction

.. GENERATED FROM PYTHON SOURCE LINES 65-78

.. code-block:: Python

    n_samples = 30
    label_func = [fr"$\theta = {np.round(t/np.pi, 2)}$" + r"$\pi$" for t in predom_dirs]

    fig = vz.show_data_vis(
        flow_data,
        patch_vis,
        label_func=label_func,
        angles=predom_dirs,
        sampling_method="angle",
        max_samples=n_samples,
    )
    plt.show()




.. image-sg:: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_001.png
   :alt: 02 synthetic optical flow and natural image patches
   :srcset: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_001.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 79-80

Persistent homology evidence (optional)

.. GENERATED FROM PYTHON SOURCE LINES 80-92

.. code-block:: Python

    if RUN_HEAVY:
        dgms_2 = ripser(flow_data, coeff=2, maxdim=2, n_perm=500)["dgms"]
        dgms_3 = ripser(flow_data, coeff=3, maxdim=2, n_perm=500)["dgms"]

        fig, axes = plt.subplots(1, 2, figsize=(10, 4), sharex=True, sharey=True)
        plot_diagrams(dgms_2, ax=axes[0], title="coeff = 2")
        plot_diagrams(dgms_3, ax=axes[1], title="coeff = 3")
        plt.tight_layout()
        plt.show()
    else:
        print("Skipping Ripser demo (set RUN_HEAVY = True to run).")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Skipping Ripser demo (set RUN_HEAVY = True to run).




.. GENERATED FROM PYTHON SOURCE LINES 93-94

Cover the base space RP^1 by metric balls

.. GENERATED FROM PYTHON SOURCE LINES 94-105

.. code-block:: Python

    n_flow_landmarks = 12
    flow_landmarks = np.linspace(0, np.pi, n_flow_landmarks, endpoint=False)
    flow_overlap = 1.4
    flow_radius = flow_overlap * np.pi / (2 * n_flow_landmarks)

    flow_cover = cb.MetricBallCover(predom_dirs, flow_landmarks, flow_radius, metric=rp1_metric())
    flow_cover.build()

    flow_cover.summarize(plot=True)
    plt.show()




.. image-sg:: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_002.png
   :alt: $0$-Simplices: $|U_i|$, $1$-Simplices: $|U_i \cap U_j|$
   :srcset: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_002.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    <IPython.core.display.Markdown object>




.. GENERATED FROM PYTHON SOURCE LINES 106-107

Local circular features (persistence on each fiber preimage)

.. GENERATED FROM PYTHON SOURCE LINES 107-125

.. code-block:: Python

    fiber_ids, dense_idx_list, rips_list = cb.get_local_rips(
        flow_data,
        flow_cover.U,
        to_view=[0, 3, 8],
        maxdim=1,
        n_perm=500 if RUN_HEAVY else 200,
        random_state=0,
    )

    cb.plot_local_rips(
        fiber_ids,
        rips_list,
        n_cols=3,
        titles="default",
        font_size=16,
    )
    plt.show()




.. image-sg:: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_003.png
   :alt: $\pi^{-1}(U_{0})$, $\pi^{-1}(U_{3})$, $\pi^{-1}(U_{8})$
   :srcset: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_003.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 126-127

Main bundle construction: local circular coords + Procrustes transitions

.. GENERATED FROM PYTHON SOURCE LINES 127-134

.. code-block:: Python

    flow_bundle = cb.build_bundle(
        flow_data,
        flow_cover,
        # CircularCoords_cls=CircularCoords,  # optional
        show=True,
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

            Coordinatizing set 1/12...
            Coordinatizing set 2/12...
            Coordinatizing set 3/12...
            Coordinatizing set 4/12...
            Coordinatizing set 5/12...
            Coordinatizing set 6/12...
            Coordinatizing set 7/12...
            Coordinatizing set 8/12...
            Coordinatizing set 9/12...
            Coordinatizing set 10/12...
            Coordinatizing set 11/12...
            Coordinatizing set 12/12...
                            Estimating transition functions...
            Gathering summary data...
            Computing characteristic class representatives...
            <IPython.core.display.Math object>




.. GENERATED FROM PYTHON SOURCE LINES 135-136

Global trivialization (torus case should be orientable/trivial in this sense)

.. GENERATED FROM PYTHON SOURCE LINES 136-139

.. code-block:: Python

    flow_triv_result = flow_bundle.get_global_trivialization()
    print("Global coordinates computed.")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Global coordinates computed.




.. GENERATED FROM PYTHON SOURCE LINES 140-141

Visualize patches arranged by (base angle, fiber coordinate)

.. GENERATED FROM PYTHON SOURCE LINES 141-157

.. code-block:: Python

    per_row = 5
    per_col = 9
    coords = np.column_stack([predom_dirs.reshape(-1, 1), flow_triv_result.F.reshape(-1, 1)])

    fig = vz.lattice_vis(
        flow_data,
        coords,
        patch_vis,
        per_row=per_row,
        per_col=per_col,
        figsize=19,
        thumb_px=350,
        dpi=350,
    )
    plt.show()




.. image-sg:: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_004.png
   :alt: 02 synthetic optical flow and natural image patches
   :srcset: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_004.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 158-160

Klein bottle model: high-contrast natural image patches
-------------------------------------------------------

.. GENERATED FROM PYTHON SOURCE LINES 160-167

.. code-block:: Python

    n_img_patches = 5000
    n_img = 3

    rng = np.random.default_rng(0)
    img_data = sy.sample_nat_img_kb(n_img_patches, n=n_img, rng=rng)[0]
    print(f"{n_img_patches} {n_img}-by-{n_img} natural image patches generated.")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    5000 3-by-3 natural image patches generated.




.. GENERATED FROM PYTHON SOURCE LINES 168-169

Predominant gradient direction in RP^1

.. GENERATED FROM PYTHON SOURCE LINES 169-172

.. code-block:: Python

    grad_dirs = sy.get_gradient_dirs(img_data)[0]
    print("Predominant gradient directions computed.")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Predominant gradient directions computed.




.. GENERATED FROM PYTHON SOURCE LINES 173-174

Visualize a sample arranged by direction

.. GENERATED FROM PYTHON SOURCE LINES 174-187

.. code-block:: Python

    n_samples = 30
    label_func = [fr"$\theta = {np.round(t/np.pi, 2)}$" + r"$\pi$" for t in grad_dirs]

    fig = vz.show_data_vis(
        img_data,
        patch_vis,
        label_func=label_func,
        angles=grad_dirs,
        sampling_method="angle",
        max_samples=n_samples,
    )
    plt.show()




.. image-sg:: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_005.png
   :alt: 02 synthetic optical flow and natural image patches
   :srcset: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_005.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 188-189

Persistent homology evidence (optional)

.. GENERATED FROM PYTHON SOURCE LINES 189-201

.. code-block:: Python

    if RUN_HEAVY:
        dgms_2 = ripser(img_data, coeff=2, maxdim=2, n_perm=500)["dgms"]
        dgms_3 = ripser(img_data, coeff=3, maxdim=2, n_perm=500)["dgms"]

        fig, axes = plt.subplots(1, 2, figsize=(10, 4), sharex=True, sharey=True)
        plot_diagrams(dgms_2, ax=axes[0], title="coeff = 2")
        plot_diagrams(dgms_3, ax=axes[1], title="coeff = 3")
        plt.tight_layout()
        plt.show()
    else:
        print("Skipping Ripser demo (set RUN_HEAVY = True to run).")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Skipping Ripser demo (set RUN_HEAVY = True to run).




.. GENERATED FROM PYTHON SOURCE LINES 202-203

Cover RP^1

.. GENERATED FROM PYTHON SOURCE LINES 203-214

.. code-block:: Python

    n_img_landmarks = 12
    img_landmarks = np.linspace(0, np.pi, n_img_landmarks, endpoint=False)
    img_overlap = 1.4
    img_radius = img_overlap * np.pi / (2 * n_img_landmarks)

    img_cover = cb.MetricBallCover(grad_dirs, img_landmarks, img_radius, metric=rp1_metric())
    img_cover.build()

    img_cover.summarize(plot=True)
    plt.show()




.. image-sg:: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_006.png
   :alt: $0$-Simplices: $|U_i|$, $1$-Simplices: $|U_i \cap U_j|$
   :srcset: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_006.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    <IPython.core.display.Markdown object>




.. GENERATED FROM PYTHON SOURCE LINES 215-216

Local circular features

.. GENERATED FROM PYTHON SOURCE LINES 216-234

.. code-block:: Python

    fiber_ids, dense_idx_list, rips_list = cb.get_local_rips(
        img_data,
        img_cover.U,
        to_view=[0, 3, 8],
        maxdim=1,
        n_perm=500 if RUN_HEAVY else 200,
        random_state=0,
    )

    cb.plot_local_rips(
        fiber_ids,
        rips_list,
        n_cols=3,
        titles="default",
        font_size=16,
    )
    plt.show()




.. image-sg:: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_007.png
   :alt: $\pi^{-1}(U_{0})$, $\pi^{-1}(U_{3})$, $\pi^{-1}(U_{8})$
   :srcset: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_007.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 235-236

Main bundle construction (nontrivial global structure; expect obstruction)

.. GENERATED FROM PYTHON SOURCE LINES 236-243

.. code-block:: Python

    img_bundle = cb.build_bundle(
        img_data,
        img_cover,
        # CircularCoords_cls=CircularCoords,  # optional
        show=True,
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

            Coordinatizing set 1/12...
            Coordinatizing set 2/12...
            Coordinatizing set 3/12...
            Coordinatizing set 4/12...
            Coordinatizing set 5/12...
            Coordinatizing set 6/12...
            Coordinatizing set 7/12...
            Coordinatizing set 8/12...
            Coordinatizing set 9/12...
            Coordinatizing set 10/12...
            Coordinatizing set 11/12...
            Coordinatizing set 12/12...
                            Estimating transition functions...
            Gathering summary data...
            Computing characteristic class representatives...
            <IPython.core.display.Math object>




.. GENERATED FROM PYTHON SOURCE LINES 244-245

Global trivialization after "cut" (as implemented in your pipeline)

.. GENERATED FROM PYTHON SOURCE LINES 245-248

.. code-block:: Python

    img_triv_result = img_bundle.get_global_trivialization()
    print("Global coordinates computed.")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Global coordinates computed.




.. GENERATED FROM PYTHON SOURCE LINES 249-250

Show coordinatized patches

.. GENERATED FROM PYTHON SOURCE LINES 250-266

.. code-block:: Python

    per_row = 5
    per_col = 9
    coords = np.column_stack([grad_dirs.reshape(-1, 1), img_triv_result.F.reshape(-1, 1)])

    fig = vz.lattice_vis(
        img_data,
        coords,
        patch_vis,
        per_row=per_row,
        per_col=per_col,
        figsize=19,
        thumb_px=350,
        dpi=350,
    )
    plt.show()




.. image-sg:: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_008.png
   :alt: 02 synthetic optical flow and natural image patches
   :srcset: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_008.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 267-268

Orientation cocycle comparisons on the circle nerve

.. GENERATED FROM PYTHON SOURCE LINES 268-275

.. code-block:: Python

    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(18, 7), dpi=150)

    flow_bundle.show_circle_nerve(title="Optical Flow Patches", ax=ax1, show=False)
    img_bundle.show_circle_nerve(title="Natural Image Patches", ax=ax2, show=False)

    plt.tight_layout()
    plt.show()



.. image-sg:: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_009.png
   :alt: Optical Flow Patches, Natural Image Patches
   :srcset: /tutorials/auto_examples/images/sphx_glr_02_synthetic_optical_flow_and_natural_image_patches_009.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 8.479 seconds)


.. _sphx_glr_download_tutorials_auto_examples_02_synthetic_optical_flow_and_natural_image_patches.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: 02_synthetic_optical_flow_and_natural_image_patches.ipynb <02_synthetic_optical_flow_and_natural_image_patches.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: 02_synthetic_optical_flow_and_natural_image_patches.py <02_synthetic_optical_flow_and_natural_image_patches.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: 02_synthetic_optical_flow_and_natural_image_patches.zip <02_synthetic_optical_flow_and_natural_image_patches.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
