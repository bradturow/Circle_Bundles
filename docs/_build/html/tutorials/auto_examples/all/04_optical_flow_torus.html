

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sintel Optical Flow Dataset &mdash; circle_bundles 0+unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/myst_sphinx_gallery.css?v=92de7a9e" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=27db1736"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Star Pyramid Meshes" href="05_triangle_meshes.html" />
    <link rel="prev" title="Synthetic Natural Image Patches" href="03_synthetic_natural_image_patches.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            circle_bundles
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#basic-installation">Basic installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#optional-dependencies">Optional dependencies</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#minimal-working-example">Minimal Working Example</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Theory</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../theory/index.html">Theory</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../theory/index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory/index.html#algorithms">Algorithms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../theory/index.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../theory/index.html#cocycle-fitting">Cocycle Fitting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../theory/index.html#classification">Classification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../theory/index.html#coordinatization">Coordinatization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory/index.html#algorithm-1-local-trivializations-and-transition-matrices">Algorithm 1: Local Trivializations and Transition Matrices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory/index.html#algorithm-2-characteristic-classes">Algorithm 2: Characteristic Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory/index.html#algorithm-3-pullback-bundle-coordinates">Algorithm 3: Pullback Bundle Coordinates</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/core.html">Core pipeline</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core.html#circle_bundles.Bundle"><code class="docutils literal notranslate"><span class="pre">Bundle</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/results.html">Result and Configuration Dataclasses</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/results.html#main-result-containers">Main Result Containers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/results.html#lower-level-result-containers">Lower-Level Result Containers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/results.html#configuration-objects">Configuration Objects</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/covers.html">Covers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.CoverData.html">circle_bundles.CoverData</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.get_metric_ball_cover.html">circle_bundles.get_metric_ball_cover</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.get_s2_fibonacci_cover.html">circle_bundles.get_s2_fibonacci_cover</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.get_rp2_fibonacci_cover.html">circle_bundles.get_rp2_fibonacci_cover</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/metrics.html">Metrics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.EuclideanMetric.html">circle_bundles.EuclideanMetric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.S1AngleMetric.html">circle_bundles.S1AngleMetric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.RP1AngleMetric.html">circle_bundles.RP1AngleMetric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.S1UnitVectorMetric.html">circle_bundles.S1UnitVectorMetric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.RP1UnitVectorMetric.html">circle_bundles.RP1UnitVectorMetric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.RP2UnitVectorMetric.html">circle_bundles.RP2UnitVectorMetric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.T2FlatMetric.html">circle_bundles.T2FlatMetric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.Torus_DiagQuotientMetric_R4.html">circle_bundles.Torus_DiagQuotientMetric_R4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.Torus_KleinQuotientMetric_R4.html">circle_bundles.Torus_KleinQuotientMetric_R4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.RP2_TrivialMetric.html">circle_bundles.RP2_TrivialMetric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.RP2_TwistMetric.html">circle_bundles.RP2_TwistMetric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.RP2_FlipMetric.html">circle_bundles.RP2_FlipMetric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.S3QuotientMetric.html">circle_bundles.S3QuotientMetric</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utilities_analysis.html">Analysis utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.fiberwise_clustering.html">circle_bundles.fiberwise_clustering</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.get_local_pca.html">circle_bundles.get_local_pca</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.get_local_rips.html">circle_bundles.get_local_rips</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.plot_local_rips.html">circle_bundles.plot_local_rips</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.get_cocycle_dict.html">circle_bundles.get_cocycle_dict</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.lift_base_points.html">circle_bundles.lift_base_points</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utilities_viz.html">Visualization utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.viz.html">circle_bundles.viz</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utilities_synthetic.html">Synthetic datasets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.synthetic.html">circle_bundles.synthetic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utilities_optical_flow.html">Optical flow utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/generated/circle_bundles.optical_flow.html">circle_bundles.optical_flow</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">All Tutorials</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01_product_torus.html">Torus With Varying Fiber Radius</a></li>
<li class="toctree-l3"><a class="reference internal" href="02_foldy_klein_bottle.html">Folded Klein Bottle</a></li>
<li class="toctree-l3"><a class="reference internal" href="03_synthetic_natural_image_patches.html">Synthetic Natural Image Patches</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Sintel Optical Flow Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="05_triangle_meshes.html">Star Pyramid Meshes</a></li>
<li class="toctree-l3"><a class="reference internal" href="06_tri_prism_densities.html">Triangle Prism Densities</a></li>
<li class="toctree-l3"><a class="reference internal" href="07_star_density_unwrapping.html">Star Density Unwrapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="08_quotients_of_s2_trivial.html">Quotient Bundles</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#all-tutorials">All Tutorials</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">circle_bundles</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Tutorials</a></li>
          <li class="breadcrumb-item"><a href="index.html">All Tutorials</a></li>
      <li class="breadcrumb-item active">Sintel Optical Flow Dataset</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/tutorials/auto_examples/all/04_optical_flow_torus.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="sintel-optical-flow-dataset">
<span id="example-04-optical-flow-torus"></span><h1>Sintel Optical Flow Dataset<a class="headerlink" href="#sintel-optical-flow-dataset" title="Link to this heading"></a></h1>
<p>In this tutorial, we apply the <code class="docutils literal notranslate"><span class="pre">circle_bundles</span></code> pipeline to confirm and expand upon the 2-manifold model proposed in <span id="id1">[<a class="reference internal" href="../../../references.html#id5" title="Henry Adams, Johnathan Bush, Brittany Carr, Lara Kassab, and Joshua Mirth. A torus model for optical flow. Pattern Recognition Letters, 129:304–310, 2020. URL: https://doi.org/10.1016/j.patrec.2019.11.029, arXiv:arXiv:1812.00875, doi:10.1016/j.patrec.2019.11.029.">ABC+20</a>]</span> for high-contrast optical flow patches sampled from the MPI-Sintel dataset <span id="id2">[<a class="reference internal" href="../../../references.html#id6" title="D. J. Butler, J. Wulff, G. B. Stanley, and M. J. Black. A naturalistic open source movie for optical flow evaluation. In European Conference on Computer Vision (ECCV), Part IV, LNCS 7577, 611–625. Springer-Verlag, 2012. URL: https://link.springer.com/chapter/10.1007/978-3-642-33783-3_44, doi:10.1007/978-3-642-33783-3_44.">BWSB12</a>]</span>. The model is homeomorphic to a torus, but the topology cannot be satsfactorally detected from a direct persistence computation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ripser</span><span class="w"> </span><span class="kn">import</span> <span class="n">ripser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">persim</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_diagrams</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">circle_bundles</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cb</span>
</pre></div>
</div>
</div>
</div>
<p>The MPI Sintel dataset is provided by the Max Planck Institute for Informatics and is subject to its original license terms. Download the raw optical flow frames from the official Sintel website: <code class="docutils literal notranslate"><span class="pre">http://sintel.is.tue.mpg.de/downloads</span></code></p>
<p>Get a large sample of 3 x 3 optical flow patches from the Sintel dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">patches_per_frame</span> <span class="o">=</span> <span class="mi">400</span>
<span class="n">folder_path</span> <span class="o">=</span> <span class="s2">&quot;.../MPI-Sintel-complete/training/flow&quot;</span>   <span class="c1">#change to your path to the Sintel flow frames</span>

<span class="n">patch_df</span><span class="p">,</span> <span class="n">file_paths</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">get_patch_sample</span><span class="p">(</span>
    <span class="n">folder_path</span><span class="p">,</span>
    <span class="n">patches_per_frame</span> <span class="o">=</span> <span class="n">patches_per_frame</span><span class="p">,</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">patch_df</span><span class="p">)</span><span class="si">}</span><span class="s1"> optical flow patches sampled&#39;</span><span class="p">)</span>

<span class="c1">#Downsample if necessary</span>
<span class="n">max_samples</span> <span class="o">=</span> <span class="mi">400000</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">patch_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_samples</span><span class="p">:</span>
    <span class="n">patch_df</span> <span class="o">=</span> <span class="n">patch_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">max_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Collecting samples from scene 23, frame 49
Finalizing dataframe... Done

416400 optical flow patches sampled
</pre></div>
</div>
</div>
</div>
<p>Next, preprocess the data – compute the <span class="math notranslate nohighlight">\(\textit{contrast norm}\)</span> of each patch (see <span id="id3">[<a class="reference internal" href="../../../references.html#id5" title="Henry Adams, Johnathan Bush, Brittany Carr, Lara Kassab, and Joshua Mirth. A torus model for optical flow. Pattern Recognition Letters, 129:304–310, 2020. URL: https://doi.org/10.1016/j.patrec.2019.11.029, arXiv:arXiv:1812.00875, doi:10.1016/j.patrec.2019.11.029.">ABC+20</a>]</span> for the formal definition) and keep only patches with contrast norm in the top 20%.  Then, use a KNN density estimator to measure the density of the dataset near each datapoint:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hc_frac</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">max_samples</span> <span class="o">=</span> <span class="mi">50000</span>
<span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">]</span>

<span class="n">patch_df</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">preprocess_flow_patches</span><span class="p">(</span>
    <span class="n">patch_df</span><span class="p">,</span>
    <span class="n">hc_frac</span> <span class="o">=</span> <span class="n">hc_frac</span><span class="p">,</span>
    <span class="n">max_samples</span> <span class="o">=</span> <span class="n">max_samples</span><span class="p">,</span>
    <span class="n">k_list</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, keep only the top 50% of patches by density value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="mf">0.5</span> 
<span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">patch_df</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">patch_df</span><span class="p">[</span><span class="s1">&#39;patch&#39;</span><span class="p">])[:</span><span class="n">n_samples</span><span class="p">]</span>    <span class="c1">#Data is already sorted in decreasing order by density</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Downsampled to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1"> patches&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downsampled to 25000 patches
</pre></div>
</div>
</div>
</div>
<p>Compute a persistence diagram from a sample of the dataset.  If the dataset is truly concentrated around the proposed torus model, we would expect to see two 1-dimensional persistent classes and a persistent class in dimension 2:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diagrams</span> <span class="o">=</span> <span class="n">ripser</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">maxdim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_perm</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)[</span><span class="s1">&#39;dgms&#39;</span><span class="p">]</span>
<span class="n">plot_diagrams</span><span class="p">(</span><span class="n">diagrams</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/1a4c0b60680a2d48c2bb863107acba5ae540a4b9ce972d5d10f9ddb24fc4cc51.png" src="../../../_images/1a4c0b60680a2d48c2bb863107acba5ae540a4b9ce972d5d10f9ddb24fc4cc51.png" />
</div>
</div>
<p>Observe that we see a single 1-dimensional persistent class and no persistent classes in dimension 2.</p>
<p>Proceed with local-to-global analysis.  Compute the predominant flow axis in <span class="math notranslate nohighlight">\(\mathbb{RP}^{1}\)</span> (as introduced by Adams et al.) and directionality for each patch, and construct a cover of <span class="math notranslate nohighlight">\(\mathbb{RP}^{1}\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predom_dirs</span><span class="p">,</span> <span class="n">ratios</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">get_predominant_dirs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  

<span class="c1">#Construct a cover of the base space</span>
<span class="n">n_landmarks</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">landmarks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">n_landmarks</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">overlap</span> <span class="o">=</span> <span class="mf">1.99</span>
<span class="n">radius</span> <span class="o">=</span> <span class="n">overlap</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n_landmarks</span><span class="p">)</span>

<span class="n">cover</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">get_metric_ball_cover</span><span class="p">(</span>
    <span class="n">predom_dirs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">landmarks</span><span class="p">,</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span><span class="p">,</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">RP1AngleMetric</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">bundle</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">Bundle</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">cover</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>View a sample of the dataset arranged by predominant flow axis:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">patch_vis</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">make_patch_visualizer</span><span class="p">()</span>

<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">label_func</span> <span class="o">=</span> <span class="p">[</span><span class="sa">fr</span><span class="s2">&quot;$\theta = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pred</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">$&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;$\pi$&quot;</span> <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">predom_dirs</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">show_data_vis</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> 
    <span class="n">patch_vis</span><span class="p">,</span> 
    <span class="n">label_func</span> <span class="o">=</span> <span class="n">label_func</span><span class="p">,</span> 
    <span class="n">angles</span> <span class="o">=</span> <span class="n">predom_dirs</span><span class="p">,</span> 
    <span class="n">sampling_method</span> <span class="o">=</span> <span class="s1">&#39;angle&#39;</span><span class="p">,</span> 
    <span class="n">max_samples</span> <span class="o">=</span> <span class="n">n_samples</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/4888fd07d86312179e04782049d405e3cd991afa4dfba69354bfcb82ea1bb292.png" src="../../../_images/4888fd07d86312179e04782049d405e3cd991afa4dfba69354bfcb82ea1bb292.png" />
</div>
</div>
<p>Compute a PCA projection for the data in each set <span class="math notranslate nohighlight">\(\pi^{-1}(U_{j})\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">get_local_pca</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">cover</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">to_view</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/7a862360de60adaf7497730c6562c4aedf26b1158619d269dfc76d29b4ab7b09.png" src="../../../_images/7a862360de60adaf7497730c6562c4aedf26b1158619d269dfc76d29b4ab7b09.png" />
</div>
</div>
<p>The PCA projections suggest the data in each <span class="math notranslate nohighlight">\(\pi^{-1}(U_{j})\)</span> is concentrated near the unit circle in some plane, supporting the hypothesis that the data has the structure of a discrete approximate circle bundle over <span class="math notranslate nohighlight">\(\mathbb{RP}^{1}\)</span>. Up to isormorphism, there are two possible global structures for a circle bundle over <span class="math notranslate nohighlight">\(\mathbb{RP}^{1}\cong\mathbb{S}^{1}\)</span>, namely the torus (trivial) and the Klein bottle (non-orientable). These two possibilities are distinguished by the orientation class <span class="math notranslate nohighlight">\(w_{1}\)</span>.</p>
<p>Now, construct local circular coordinates, compute approximate transition matrices and characteristic classes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">local_triv_result</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">get_local_trivs</span><span class="p">(</span><span class="n">show_summary</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">class_result</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">get_classes</span><span class="p">(</span><span class="n">show_classes</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\begin{split}\displaystyle \begin{aligned}\textbf{Local Trivialization Summary} &amp; \\[6pt]\quad \text{Trivialization error} &amp;:\quad \varepsilon_{\text{triv}} := \sup_{(j\,k)\in\mathcal{N}(\mathcal{U})}\sup_{x\in\pi^{-1}(U_j\cap U_k)} d_{\mathbb{C}}(\Omega_{jk}f_k(x),f_j(x)) = 0.244\ \left(\varepsilon_{\text{triv}}^{\text{geo}}=0.078\pi\right)\\[3pt]\quad \text{Mean triv error} &amp;:\quad \bar{\varepsilon}_{\text{triv}} = 0.062\ \left(\bar{\varepsilon}_{\text{triv}}^{\text{geo}}=0.020\pi\right)\\[3pt]\quad \text{Surjectivity defect} &amp;:\quad \delta := \sup_{(i\,j\,k)\in\mathcal{N}(\mathcal{U})}\min_{v\in\{i,j,k\}} d_H\!\left(f_v(\pi^{-1}(U_i\cap U_j\cap U_k)),\mathbb{S}^1\right) = 0.000\\[3pt]\quad \text{Stability ratio} &amp;:\quad \alpha := \varepsilon_{\text{triv}}/(1-\delta) = 0.244\\[3pt]\quad \text{Cocycle error} &amp;:\quad \varepsilon_{\mathrm{coc}} := \sup_{(i\,j\,k)\in\mathcal{N}(\mathcal{U})}\left\|\Omega_{ij}\Omega_{jk}\Omega_{ki}-I\right\|_F = 0.000\end{aligned}\end{split}\]</div>
<div class="output text_latex math notranslate nohighlight">
\[\begin{split}\displaystyle \begin{aligned}\textbf{Characteristic Classes} &amp; \\[8pt]\quad \text{Stiefel--Whitney} &amp;:\quad w_1 = 0\ (\text{orientable})\\[4pt]\quad \text{Euler} &amp;:\quad e = 0\ (\text{trivial})\end{aligned}\end{split}\]</div>
</div>
</div>
<p>The computation above confirms that the global structure is trivial, so a global coordinate system is possible.  Synchronize local circular coordinates to construct a toroidal coordinate system for the dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fiber_angles</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">get_global_trivialization</span><span class="p">(</span><span class="n">pou</span> <span class="o">=</span> <span class="n">cover</span><span class="o">.</span><span class="n">pou</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, view a sample of high-directionality patches arranged by toroidal coordinates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">high_inds</span> <span class="o">=</span> <span class="n">ratios</span> <span class="o">&gt;</span> <span class="n">thresh</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">high_inds</span><span class="p">)</span><span class="si">}</span><span class="s1"> high-directionality patches&#39;</span><span class="p">)</span>
<span class="n">high_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">high_inds</span><span class="p">]</span>


<span class="n">per_row</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">per_col</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">predom_dirs</span><span class="p">[</span><span class="n">high_inds</span><span class="p">],</span> <span class="n">fiber_angles</span><span class="p">[</span><span class="n">high_inds</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">lattice_vis</span><span class="p">(</span>
    <span class="n">high_data</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">,</span>
    <span class="n">patch_vis</span><span class="p">,</span>
    <span class="n">per_row</span><span class="o">=</span><span class="n">per_row</span><span class="p">,</span>
    <span class="n">per_col</span> <span class="o">=</span> <span class="n">per_col</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
    <span class="n">thumb_px</span><span class="o">=</span><span class="mi">350</span><span class="p">,</span>   
    <span class="n">dpi</span><span class="o">=</span><span class="mi">350</span><span class="p">,</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15971 high-directionality patches
</pre></div>
</div>
<img alt="../../../_images/200f6d5f06cc998ab4779dc31ec0cfe440678c4beb32432ee5049fe586808b18.png" src="../../../_images/200f6d5f06cc998ab4779dc31ec0cfe440678c4beb32432ee5049fe586808b18.png" />
</div>
</div>
<p>View a sample of low-directionality patches arranged by toroidal coordinates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">low_inds</span> <span class="o">=</span> <span class="n">ratios</span> <span class="o">&lt;</span> <span class="n">thresh</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">low_inds</span><span class="p">)</span><span class="si">}</span><span class="s1"> low-directionality patches&#39;</span><span class="p">)</span>
<span class="n">low_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">low_inds</span><span class="p">]</span>


<span class="n">per_row</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">per_col</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">predom_dirs</span><span class="p">[</span><span class="n">low_inds</span><span class="p">],</span> <span class="n">fiber_angles</span><span class="p">[</span><span class="n">low_inds</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">lattice_vis</span><span class="p">(</span>
    <span class="n">low_data</span><span class="p">,</span>
    <span class="n">coords</span><span class="p">,</span>
    <span class="n">patch_vis</span><span class="p">,</span>
    <span class="n">per_row</span><span class="o">=</span><span class="n">per_row</span><span class="p">,</span>
    <span class="n">per_col</span> <span class="o">=</span> <span class="n">per_col</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
    <span class="n">thumb_px</span><span class="o">=</span><span class="mi">350</span><span class="p">,</span>   
    <span class="n">dpi</span><span class="o">=</span><span class="mi">350</span><span class="p">,</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5353 low-directionality patches
</pre></div>
</div>
<img alt="../../../_images/f5270033a63bde4ee701760dc52989accf55180a016311d3ea7725dd091335b4.png" src="../../../_images/f5270033a63bde4ee701760dc52989accf55180a016311d3ea7725dd091335b4.png" />
</div>
</div>
<p>Observe that every column is nearly identical: this reflects the fact that the low-directionality data is concentrated near a single circle at the center of the thickened torus structure.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="03_synthetic_natural_image_patches.html" class="btn btn-neutral float-left" title="Synthetic Natural Image Patches" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="05_triangle_meshes.html" class="btn btn-neutral float-right" title="Star Pyramid Meshes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Brad Turow.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>